= MongoDB - NoSQL Optimizations
:imagesdir: images
:source-highlighter: highlightjs
:revealjs_theme: white
:revealjs_history: true
:revealjs_slideNumber: true
:customcss: custom.css
:icons: font
:school: supdevinci.png

image:{school}[]

== `Hello world!`

ü´µ üé§ ‚ùì

[.columns.is-vcentered]
=== Qui je suis

[.column]
image:avatar.jpg[width=60%]

[.column]
https://twitter.com/NicolasComet[icon:twitter[]@NicolasComet] +
https://github.com/ncomet[icon:github[].com/ncomet] +
https://www.linkedin.com/in/nicolascomet[icon:linkedin[].com/nicolascomet] +


[%notitle]
=== Parcours

image:betclic.png[width=20%] +
ü•Ωüß™ Experience Lab

---

image:ubisoft.jpg[width=10%] +
‚òÅÔ∏èüéÆ  Streaming Team

---

image:lectra.png[width=20%] +
üöò üõãÔ∏è üëó Cloud automation

---

=== üé§ conf√©rences

image::confs.jpeg[]

== Jour 1

=== Introduction √† MongoDB

=== NoSQL ?

[%step]
**N**ot **O**nly *SQL*

[%step]
Categorie de icon:database[]

[%step]
!= `RDBMS`

=== Relationnel

* Donn√©es structur√©es, pr√©d√©finies
* Nombreuses contraintes
* Relations complexes
* Transactions fortes

=== NoSQL

* Mod√©lisation diff√©rente
* Larges volumes de donn√©es
* Donn√©es non/semi-structur√©es
* Sch√©mas flexibles
* Mise √† l'√©chelle horizontale

=== Cat√©gories

* Cl√©-valeur (Redis, AWS DynamoDB)
* Documents (MongoDB, CouchDB)
* Graphes (Neo4J)
* Colonnes (Cassandra, GCP BigQuery, AWS Redshift)

=== ACID / BASE

=== ACID

Atomicity:: The database transaction must completely succeed or completely fail. Partial success is not allowed.
Consistency:: During the database transaction, the DB progresses from one valid state to another. The state is never invalid.

[%notitle]
=== ACID

Isolation:: The client's database transaction must occur in isolation from other clients attempting to transact with the DB.
Durability:: Once a transaction is committed, its changes are permanently stored in the database, even in the event of a system failure or crash. This ensures that committed transactions persist and are not lost.

=== BASE

Basically Available:: The system remains operational and responsive despite failures or partitions in the network.The system as a whole remains available to serve requests.
Soft State:: Data can be inconsistent. The system may temporarily exist in an inconsistent state, but it will eventually converge to a consistent state.

[%notitle]
=== BASE

Eventual consistency:: Given enough time and absence of further updates, all replicas of the data will eventually converge to a consistent state.

=== Mod√®le R/W

[.stretch]
image::r-w-model.png[]

=== MongoDB

* Cat√©gorie: documents
* ACID en lecture/√©criture *au document*
* Optionnel BASE en lecture du document

image:read-write.png[width=40%] image:read-write2.png[width=37%]

=== MongoDB

* Schemaless
* Documents h√©t√©rog√®nes
* JSON (BSON ‚öôÔ∏è)

[%notitle]
=== Relationnel vs. Document

[%header,cols="1,1"] 
|===
|Relationnel
|Document

|database
|database

|table
|collection

|row
|document

|column
|field

|PK (primary key)
|primary index (`_id`)

|===

[%notitle]
=== Relationnel vs. Document

[%header,cols="1,1"] 
|===
|Relationnel
|Document

|FK (foreign key)
|N/A

|JOIN
|N/A (~)
|===

=== Requ√™tes

RDBMS -> SQL

MongoDB -> Syntaxe JavaScript, queries JSON

=== Document

[source, json]
----
{
  _id: ObjectId("509a8fb2f3f4948bd2f983a0"),
  name: "Jon Snow",
  age: 24,
  died: true,
  politicalInfo: {
    house: "Targaryen",
    affiliations: ["House Stark", "Night's Watch"]
  },
  parents: [
    {
      id: "65db3d35964a1e955390b81e",
      name: "Lyanna Stark",
      age: 16
    },
    {
      id: "75db3d3fa70e10a0b73f4d30",
      name: "Rhaegar Targaryen",
      age: 97
    }
  ]
}
----

=== Programmation Objet (POO)

[source, java]
----
public record GoTCharacter(UUID id, String name, int age, List<GoTCharacter> parents) {}
----

=== Outils, binaires

CLI : `mongosh`

image:compass.png[width=80%]

=== TD 1

https://ncomet.github.io/lectures/advanced-mongodb/tds/td1.html

== Jour 2

=== Indexation

Qu'est-ce qu'un index ? üëà

[%step]
* üìò -> üëâüìñ
[%step]
* Optimisation
[%step]
* ‚¨á‚è±Ô∏è ex√©cution des requ√™tes

=== Indexation

Contrepartie ?

[%step]
* Co√ªt ‚è±Ô∏è √† l'√©criture
[%step]
* Co√ªt en espace (RAM/Disque)

=== Indexation

WARNING: Utilisation r√©fl√©chie

=== Index MongoDB ?

```
db.pokemons.getIndexes()
```

[source, js]
----
[
  { v: 2, key: { _id: 1 }, name: '_id_' },
  { v: 2, key: { age: -1 }, name: 'age_-1' }
]
----

L'index `_id` est obligatoire

=== Cr√©er un index

[source, js]
----
db.<collection>.createIndex(
   { (field): (value) },
   { name: "<indexName>" }
)
----

=== Supprimer un index

[source, js]
----
db.<collection>.dropIndex("<indexName>")

db.<collection>.dropIndexes([ "<index1>", "<index2>" ])
----

=== Exemple

Indexes simples (simple field)

[source, js]
----
db.collection.createIndex( { age: -1 } )
db.collection.createIndex( { nickname: 1 } )
----

=== Exemple

Indexes compos√©s

[source, js]
----
db.collection.createIndex( { age: -1, nickname: 1 } )
----

=== Ordre des champs !

[source, js]
----
db.students.createIndex( { name: 1, gpa: -1 } ) üëà
----

[source, js]
----
db.students.find( { name: "Alice", gpa: 3.6 } ) ‚úÖ
db.students.find( { name: "Bob" } ) ‚úÖ
----

[source, js]
----
db.students.find( { gpa: { $gt: 3.5 } } ) ‚ùå
----

=== Ordre des tris !

[source, js]
----
db.leaderboard.createIndex( { score: -1, username: 1 } ) üëà
----

[source, js]
----
db.leaderboard.find().sort( { score: -1, username: 1 } ) ‚úÖ
db.leaderboard.find().sort( { score: 1, username: -1 } ) ‚úÖ
----

[source, js]
----
db.leaderboard.find().sort( { username: -1, score: 1 } ) ‚ùå
db.leaderboard.find().sort( { score: 1, username: 1 } ) ‚ùå
db.leaderboard.find().sort( { score: -1, username: -1 } ) ‚ùå
----

=== Indexes multi-cl√©s

[source, js]
----
db.students.insertMany( [
   {
      "name": "Andre Robinson",
      "test_scores": [ 88, 97 ]
   },
   {
      "name": "Wei Zhang",
      "test_scores": [ 62, 73 ]
   },
   {
      "name": "Jacob Meyer",
      "test_scores": [ 92, 89 ]
   }
] )
----

[source, js]
----
db.students.createIndex( { test_scores: 1 } ) üëà
----

[source, js]
----
db.students.find({ test_scores: { $elemMatch: { $gt: 90 } } })
----

=== Analyse des index

== Jour 3

=== Mod√©lisation

=== Pipeline d'aggr√©gation

== Jour 4

=== Architecture des clusters

=== Mise √† l'√©chelle

== Jour 5

=== Profilage & Statistiques

=== Questions

=== Evaluation : diagnostic d'un cluster