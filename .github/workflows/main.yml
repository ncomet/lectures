name: Build and Deploy
on:
  push:	
    branches:	
      - main

permissions:
  contents: write

jobs:
  build-and-deploy:
    concurrency: ci-${{ github.ref }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Prepare public
        run: |
          mkdir public
          for d in */ ; do
            mkdir "public/$d"
          done
          cat > public/index.html << EOF
          <!DOCTYPE html>
          <html lang="en">
            <head>
              <meta charset="utf-8">
              <title>Lectures</title>
            </head>
            <body>
              <h1>Lectures</h1>
              <ul>
                <li><a href="/advanced-mongodb">advanced-mongodb</a></li>
              </ul>
            </body>
          </html>
          EOF
          touch public/.nojekyll

      - name: Install and Build slides
        run: |
          here=$(pwd)
          echo "$here"
          for d in */ ; do
            cd "$d/slides"
            npm ci
            npm run build
            cp -R node_modules "$here/public/$d"
            cp -R images "$here/public/$d"
            cp custom.css "$here/public/$d/custom.css"
            cp slides.html "$here/public/$d/index.html"
            touch "$here/public/$d/.nojekyll"
            cd "$here"
          done
          
      - name: Build TDs
        run: |
          for d in */ ; do
            mkdir "public/$d/tds"
            docker run --rm -v "$(pwd)/$d/tds":/documents/ asciidoctor/docker-asciidoctor asciidoctor *.adoc
            cp "$d/tds/*.html" "public/$d/tds"
          done

      - name: Deploy 🚀
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: public